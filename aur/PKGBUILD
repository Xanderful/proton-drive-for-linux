# Maintainer: Xanderful <xanderful@proton.me>
pkgname=proton-drive-linux-bin
pkgver=1.2.0
pkgrel=1
pkgdesc="Unofficial native Linux desktop client for Proton Drive (C++/GTK4)"
arch=('x86_64')
url="https://github.com/Xanderful/proton-drive-linux"
license=('Apache-2.0')
depends=('gtk4' 'libcurl' 'sqlite' 'openssl' 'rclone')
optdepends=('fuse3: for rclone mount-based sync')
provides=('proton-drive')
conflicts=('proton-drive')
options=('!strip')
source=("${pkgname}-${pkgver}.AppImage::https://github.com/Xanderful/proton-drive-linux/releases/download/v${pkgver}/proton-drive_${pkgver}_amd64.AppImage")
sha256sums=('SKIP')

prepare() {
    chmod +x "${pkgname}-${pkgver}.AppImage"
    "./${pkgname}-${pkgver}.AppImage" --appimage-extract
}

package() {
    # Install the main binary
    install -Dm755 "${srcdir}/squashfs-root/usr/bin/proton-drive" "${pkgdir}/usr/bin/proton-drive"

    # Install desktop file
    install -Dm644 "${srcdir}/squashfs-root/usr/share/applications/proton-drive.desktop" \
        "${pkgdir}/usr/share/applications/proton-drive.desktop"

    # Install icons
    for size in 32x32 128x128 256x256; do
        if [ -f "${srcdir}/squashfs-root/usr/share/icons/hicolor/${size}/apps/proton-drive.png" ]; then
            install -Dm644 "${srcdir}/squashfs-root/usr/share/icons/hicolor/${size}/apps/proton-drive.png" \
                "${pkgdir}/usr/share/icons/hicolor/${size}/apps/proton-drive.png"
        fi
    done

    # Install scalable icon if exists
    if [ -f "${srcdir}/squashfs-root/usr/share/icons/hicolor/scalable/apps/proton-drive.svg" ]; then
        install -Dm644 "${srcdir}/squashfs-root/usr/share/icons/hicolor/scalable/apps/proton-drive.svg" \
            "${pkgdir}/usr/share/icons/hicolor/scalable/apps/proton-drive.svg"
    fi

    # Install any additional libraries from AppImage if they exist
    if [ -d "${srcdir}/squashfs-root/usr/lib" ]; then
        cp -r "${srcdir}/squashfs-root/usr/lib" "${pkgdir}/usr/"
    fi
}
