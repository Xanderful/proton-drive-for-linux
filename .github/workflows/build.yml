name: Build and Release

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            python3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clone and patch WebClients
        run: |
          set -euo pipefail
          
          echo "ðŸ“¥ Cloning WebClients..."
          rm -rf WebClients
          git clone --depth=1 --single-branch --branch main \
            https://github.com/ProtonMail/WebClients.git WebClients
          
          echo "ðŸ”§ Patching dependencies..."
          python3 scripts/fix_deps.py

          # Remove yarn.lock to regenerate from package.json
          rm -f WebClients/yarn.lock

      - name: Build WebClients (Proton Drive)
        run: |
          set -euo pipefail
          
          cd WebClients

          export NODE_OPTIONS="--max-old-space-size=8192"

          echo "ðŸ“¦ Installing WebClients dependencies..."
          node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 600000

          echo "ðŸ”¨ Building Proton Drive web app..."
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build
          
          # Verify build output
          if [ ! -d "applications/drive/build" ]; then
            echo "âŒ Build failed - no output directory"
            exit 1
          fi
          
          echo "âœ… WebClients build complete"
          ls -la applications/drive/build/

          cd ..

      - name: Install Tauri dependencies
        run: yarn install

      - name: Build Tauri app (Linux)
        run: |
          echo "ðŸ”¨ Building Tauri desktop app..."
          yarn tauri build -- --bundles appimage,deb,rpm
          
          echo "âœ… Tauri build complete"
          find src-tauri/target/release/bundle -type f \
            \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \
            \)

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clone and patch WebClients
        run: |
          set -euo pipefail
          
          echo "ðŸ“¥ Cloning WebClients..."
          rm -rf WebClients
          git clone --depth=1 --single-branch --branch main \
            https://github.com/ProtonMail/WebClients.git WebClients
          
          echo "ðŸ”§ Patching dependencies..."
          python3 scripts/fix_deps.py

          # Remove yarn.lock to regenerate from package.json
          rm -f WebClients/yarn.lock

      - name: Build WebClients (Proton Drive)
        run: |
          set -euo pipefail
          cd WebClients
          
          export NODE_OPTIONS="--max-old-space-size=8192"
          
          # Removed touch yarn.lock - now uses the cloned yarn.lock

          echo "ðŸ“¦ Installing WebClients dependencies..."
          node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 600000
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build
          
          if [ ! -d "applications/drive/build" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          
          cd ..

      - name: Install Tauri dependencies
        run: yarn install

      - name: Build Tauri app (macOS)
        run: |
          yarn tauri build -- --bundles app,dmg
          
          find src-tauri/target/release/bundle -type f \
            \( -name "*.app" -o -name "*.dmg" \
            \)

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            src-tauri/target/release/bundle/macos/*.app
            src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clone and patch WebClients
        shell: bash
        env:
          PYTHONIOENCODING: utf-8 # Fix UnicodeEncodeError on Windows
        run: |
          set -euo pipefail
          
          echo "ðŸ“¥ Cloning WebClients..."
          rm -rf WebClients
          git clone --depth=1 --single-branch --branch main \
            https://github.com/ProtonMail/WebClients.git WebClients
          
          echo "ðŸ”§ Patching dependencies..."
          python3 scripts/fix_deps.py

          # Remove yarn.lock to regenerate from package.json
          rm -f WebClients/yarn.lock

      - name: Build WebClients (Proton Drive)
        shell: bash
        run: |
          set -euo pipefail
          cd WebClients
          
          export NODE_OPTIONS="--max-old-space-size=8192"
          
          # Removed touch yarn.lock - now uses the cloned yarn.lock

          echo "ðŸ“¦ Installing WebClients dependencies..."
          node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 600000
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build
          
          if [ ! -d "applications/drive/build" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          
          cd ..

      - name: Install Tauri dependencies
        run: yarn install

      - name: Build Tauri app (Windows)
        run: |
          yarn tauri build -- --bundles msi,nsis
          
          Get-ChildItem -Path src-tauri/target/release/bundle -Recurse -Include *.msi,*.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Find and copy all build artifacts
          find artifacts -type f \
            \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \
               -o -name "*.dmg" -o -name "*.app" \
               -o -name "*.exe" -o -name "*.msi" \)
            -exec cp {} release/ \;
          
          # List what we're releasing
          echo "ðŸ“¦ Release artifacts:"
          ls -lah release/
          
          # Generate checksums
          cd release
          sha256sum * > SHA256SUMS
          cat SHA256SUMS
          cd ..

      - name: Create release notes
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest
          git push -f origin latest
