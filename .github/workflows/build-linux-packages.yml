name: Build Linux Packages

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-deb-rpm-appimage:
    # Build in Debian 12 container for GLIBC 2.36 compatibility
    runs-on: ubuntu-latest
    container:
      image: debian:12
    timeout-minutes: 90

    steps:
      - name: Install git and dependencies
        run: |
          apt-get update
          apt-get install -y \
            git \
            curl \
            wget \
            build-essential \
            file \
            pkg-config \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf \
            fuse \
            libfuse2 \
            python3 \
            ca-certificates

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync version from package.json
        run: |
          VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "1.1.0")
          echo "Building version: $VERSION"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "0,/^version = \"[^\"]*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clone and patch WebClients
        run: |
          set -euo pipefail

          echo "ðŸ“¥ Cloning WebClients..."
          rm -rf WebClients .git/modules/WebClients 2>/dev/null || true
          git clean -fdx WebClients 2>/dev/null || true
          git clone --depth=1 --single-branch --branch main \
            https://github.com/ProtonMail/WebClients.git WebClients

          echo "ðŸ”§ Patching dependencies and configuring Yarn..."
          python3 scripts/fix_deps.py

          rm -f WebClients/yarn.lock

      - name: Build WebClients (Proton Drive)
        run: |
          set -euo pipefail

          mv ./package.json ./package.json.bak 2>/dev/null || true
          mv ./yarn.lock ./yarn.lock.bak 2>/dev/null || true

          cd WebClients

          echo "ðŸ“¦ Installing WebClients dependencies..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 900000

          cd ..
          mv ./package.json.bak ./package.json 2>/dev/null || true
          mv ./yarn.lock.bak ./yarn.lock 2>/dev/null || true

          echo "ðŸ“¦ Creating stubs for private packages..."
          python3 scripts/create_stubs.py

          cd WebClients

          echo "ðŸ”¨ Building Proton Drive web app..."
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build:web

          echo "ðŸ” Verifying build output..."
          if [ ! -d "applications/drive/dist" ]; then
            echo "âŒ CRITICAL: dist directory not found!"
            exit 1
          fi

          if [ ! -f "applications/drive/dist/index.html" ]; then
            echo "âŒ CRITICAL: index.html not found in dist!"
            echo "Contents of applications/drive/:"
            ls -la applications/drive/ || true
            exit 1
          fi

          echo "âœ… WebClients build verification passed"
          echo "ðŸ“¦ Dist contents:"
          ls -lah applications/drive/dist/ | head -20
          
          FILE_COUNT=$(find applications/drive/dist -type f | wc -l)
          echo "ðŸ“Š Total files in dist: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -lt 5 ]; then
            echo "âŒ CRITICAL: Too few files in dist directory!"
            exit 1
          fi

          cd ..

      - name: Verify dist path from project root
        run: |
          echo "ðŸ” Verifying dist path that Tauri will use..."
          DIST_PATH="WebClients/applications/drive/dist"
          
          if [ ! -d "$DIST_PATH" ]; then
            echo "âŒ CRITICAL: $DIST_PATH not found from project root!"
            echo "Current directory:"
            pwd
            echo "Directory structure:"
            ls -la
            exit 1
          fi
          
          if [ ! -f "$DIST_PATH/index.html" ]; then
            echo "âŒ CRITICAL: $DIST_PATH/index.html not found!"
            exit 1
          fi
          
          echo "âœ… Dist path verified from project root"
          echo "Full path: $(pwd)/$DIST_PATH"

      - name: Install Tauri dependencies
        run: npm install

      - name: Prepare desktop file for bundlers
        run: |
          # Desktop file already exists in repo at src-tauri/linux/com.proton.drive.desktop
          # Create a copy with the binary name for Tauri bundler compatibility
          cp src-tauri/linux/com.proton.drive.desktop src-tauri/linux/proton-drive.desktop
          echo "Desktop files ready"
          cat src-tauri/linux/com.proton.drive.desktop

      - name: Build DEB and RPM only (skip AppImage for now)
        run: |
          echo "ðŸ”¨ Building DEB and RPM packages..."
          npx tauri build --bundles deb,rpm --verbose

          echo "âœ… DEB and RPM build complete"

          # Rename RPM from Proton.Drive to proton-drive
          echo "ðŸ”§ Renaming RPM package..."
          cd src-tauri/target/release/bundle/rpm
          for f in Proton.Drive*.rpm; do
            if [ -f "$f" ]; then
              newname=$(echo "$f" | sed 's/Proton\.Drive/proton-drive/g')
              mv "$f" "$newname"
              echo "Renamed: $f -> $newname"
            fi
          done
          cd -

          # Fix icon names in packages - Tauri uses productName but we need identifier
          echo "ðŸ”§ Checking icon naming in packages..."
          # Note: The DEB/RPM packages are already built, icons are embedded
          # The desktop file uses Icon=com.proton.drive which requires icons to be
          # installed as com.proton.drive.{png,svg} in hicolor directories

          find src-tauri/target/release/bundle -type f \
            \( -name "*.deb" -o -name "*.rpm" \) -ls

      - name: Build AppImage manually (workaround for linuxdeploy issues)
        run: |
          set -euo pipefail
          
          echo "ðŸ”¨ Building AppImage manually..."
          
          VERSION=$(node -p "require('./package.json').version")
          BINARY_PATH="src-tauri/target/release/proton-drive"
          APPDIR="AppDir"
          
          # Verify binary exists
          if [ ! -f "$BINARY_PATH" ]; then
            echo "âŒ Binary not found at $BINARY_PATH"
            exit 1
          fi
          
          # Create AppDir structure
          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/share/applications"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/scalable/apps"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/128x128/apps"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/32x32/apps"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"
          
          # Copy binary
          cp "$BINARY_PATH" "$APPDIR/usr/bin/proton-drive"
          chmod +x "$APPDIR/usr/bin/proton-drive"
          
          # Copy desktop file with correct icon reference (use app identifier)
          cat > "$APPDIR/usr/share/applications/com.proton.drive.desktop" << 'EOF'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Proton Drive
          Comment=Secure cloud storage
          Exec=proton-drive %U
          Icon=com.proton.drive
          Categories=Utility;Network;FileTransfer;
          Keywords=proton;drive;cloud;storage;sync;
          Terminal=false
          StartupWMClass=proton-drive
          StartupNotify=true
          EOF

          # Copy icons with identifier-based naming for freedesktop compliance
          cp src-tauri/icons/proton-drive.svg "$APPDIR/usr/share/icons/hicolor/scalable/apps/com.proton.drive.svg"
          cp src-tauri/icons/128x128.png "$APPDIR/usr/share/icons/hicolor/128x128/apps/com.proton.drive.png"
          cp src-tauri/icons/32x32.png "$APPDIR/usr/share/icons/hicolor/32x32/apps/com.proton.drive.png"
          cp src-tauri/icons/128x128@2x.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/com.proton.drive.png"

          # Create top-level desktop file and icon (required by AppImage)
          cp "$APPDIR/usr/share/applications/com.proton.drive.desktop" "$APPDIR/com.proton.drive.desktop"
          cp src-tauri/icons/proton-drive.svg "$APPDIR/com.proton.drive.svg"
          ln -sf usr/share/icons/hicolor/128x128/apps/com.proton.drive.png "$APPDIR/.DirIcon"
          
          # Create AppRun with environment fixes
          cat > "$APPDIR/AppRun" << 'APPRUN_EOF'
          #!/bin/bash
          # Fix WebKitGTK EGL/GPU issues on various Linux configurations
          export GDK_GL=disable
          export WEBKIT_DISABLE_DMABUF_RENDERER=1
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          export WEBKIT_FORCE_SANDBOX=0
          export LIBGL_ALWAYS_SOFTWARE=1
          export GSK_RENDERER=cairo

          HERE="$(dirname "$(readlink -f "${0}")")"
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          
          exec "${HERE}/usr/bin/proton-drive" "$@"
          APPRUN_EOF
          chmod +x "$APPDIR/AppRun"
          
          # Download appimagetool
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool
          
          # Build AppImage
          ARCH=x86_64 ./appimagetool "$APPDIR" "proton-drive_${VERSION}_amd64.AppImage"
          
          # Move to bundle directory
          mkdir -p src-tauri/target/release/bundle/appimage
          mv "proton-drive_${VERSION}_amd64.AppImage" src-tauri/target/release/bundle/appimage/
          
          # Cleanup
          rm -rf "$APPDIR" appimagetool
          
          echo "âœ… AppImage created successfully"
          ls -lh src-tauri/target/release/bundle/appimage/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: error
          retention-days: 30