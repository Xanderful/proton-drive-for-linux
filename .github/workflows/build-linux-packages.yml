name: Build Linux Packages

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-deb-rpm-appimage:
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync version from package.json
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Building version: $VERSION"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "0,/^version = \"[^\"]*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf \
            python3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clone and patch WebClients
        run: |
          set -euo pipefail

          echo "ðŸ“¥ Cloning WebClients..."
          rm -rf WebClients .git/modules/WebClients 2>/dev/null || true
          git clean -fdx WebClients 2>/dev/null || true
          git clone --depth=1 --single-branch --branch main \
            https://github.com/ProtonMail/WebClients.git WebClients

          echo "ðŸ”§ Patching dependencies and configuring Yarn..."
          python3 scripts/fix_deps.py

          rm -f WebClients/yarn.lock

      - name: Build WebClients (Proton Drive)
        run: |
          set -euo pipefail

          mv ./package.json ./package.json.bak 2>/dev/null || true
          mv ./yarn.lock ./yarn.lock.bak 2>/dev/null || true

          cd WebClients

          echo "ðŸ“¦ Installing WebClients dependencies..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 900000

          cd ..
          mv ./package.json.bak ./package.json 2>/dev/null || true
          mv ./yarn.lock.bak ./yarn.lock 2>/dev/null || true

          echo "ðŸ“¦ Creating stubs for private packages..."
          python3 scripts/create_stubs.py

          cd WebClients

          echo "ðŸ”¨ Building Proton Drive web app..."
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build:web

          if [ ! -d "applications/drive/dist" ]; then
            echo "âŒ Build failed - no output directory"
            exit 1
          fi

          echo "âœ… WebClients build complete"
          ls -la applications/drive/dist/

          cd ..

      - name: Install Tauri dependencies
        run: npm install

      - name: Build Tauri app (DEB, RPM, AppImage)
        run: |
          echo "ðŸ”¨ Building Tauri packages..."
          npx tauri build --bundles appimage,deb,rpm

          echo "âœ… Tauri build complete"
          find src-tauri/target/release/bundle -type f \
            \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \
            \) -ls

      - name: Patch AppImage for WebKitGTK compatibility
        run: |
          echo "ðŸ”§ Patching AppImage for GPU compatibility..."

          # Install FUSE for AppImage extraction
          sudo apt-get install -y libfuse2

          cd src-tauri/target/release/bundle/appimage

          APPIMAGE=$(ls *.AppImage | head -1)
          echo "Patching: $APPIMAGE"

          # Extract AppImage
          chmod +x "$APPIMAGE"
          ./"$APPIMAGE" --appimage-extract

          # Show original AppRun for debugging
          echo "Original AppRun:"
          cat squashfs-root/AppRun

          # Create a new AppRun wrapper that sets env vars before exec
          mv squashfs-root/AppRun squashfs-root/AppRun.orig
          cat > squashfs-root/AppRun << 'APPRUN_EOF'
          #!/bin/bash
          # Fix WebKitGTK EGL/GPU issues on various Linux configurations
          # These must be set before WebKitGTK initializes

          # Completely disable GTK's OpenGL usage
          export GDK_GL=disable

          # Disable hardware acceleration in WebKitGTK
          export WEBKIT_DISABLE_DMABUF_RENDERER=1
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          export WEBKIT_FORCE_SANDBOX=0

          # Force software rendering
          export LIBGL_ALWAYS_SOFTWARE=1

          # Force GTK to use Cairo renderer instead of GL
          export GSK_RENDERER=cairo

          # Get the directory where AppRun is located
          HERE="$(dirname "$(readlink -f "${0}")")"

          # Execute the original AppRun
          exec "$HERE/AppRun.orig" "$@"
          APPRUN_EOF
          chmod +x squashfs-root/AppRun

          echo "New AppRun:"
          cat squashfs-root/AppRun

          # Repack AppImage
          rm "$APPIMAGE"

          # Download appimagetool if not present
          if [ ! -f appimagetool ]; then
            wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
            chmod +x appimagetool
          fi

          ARCH=x86_64 ./appimagetool squashfs-root "$APPIMAGE"
          rm -rf squashfs-root appimagetool

          echo "âœ… AppImage patched successfully"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: error
          retention-days: 30
