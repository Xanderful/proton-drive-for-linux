name: Build Linux Packages

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  RUST_VERSION: "stable"

jobs:
  build-deb-rpm-appimage:
    # Build in Debian 12 container for GLIBC 2.36 compatibility
    runs-on: ubuntu-latest
    container:
      image: debian:12
    timeout-minutes: 45
    defaults:
      run:
        shell: bash

    steps:
      - name: Install git and dependencies
        shell: sh
        run: |
          apt-get update
          apt-get install -y \
            bash \
            git \
            curl \
            wget \
            build-essential \
            file \
            pkg-config \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf \
            fuse \
            libfuse2 \
            ca-certificates \
            nodejs \
            npm

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync version from package.json
        run: |
          VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "1.1.0")
          echo "Building version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "0,/^version = \"[^\"]*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Tauri CLI
        run: npm install

      - name: Prepare desktop file for bundlers
        run: |
          cp src-tauri/linux/com.proton.drive.desktop src-tauri/linux/proton-drive.desktop
          echo "Desktop files ready"

      - name: Build DEB and RPM
        run: |
          echo "ðŸ”¨ Building DEB and RPM packages..."
          npx tauri build --bundles deb,rpm

          echo "âœ… DEB and RPM build complete"

          # Rename RPM from Proton.Drive to proton-drive
          echo "ðŸ”§ Renaming RPM package..."
          cd src-tauri/target/release/bundle/rpm
          for f in Proton.Drive*.rpm; do
            if [ -f "$f" ]; then
              newname=$(echo "$f" | sed 's/Proton\.Drive/proton-drive/g')
              mv "$f" "$newname"
              echo "Renamed: $f -> $newname"
            fi
          done
          cd -

          find src-tauri/target/release/bundle -type f \
            \( -name "*.deb" -o -name "*.rpm" \) -ls

      - name: Build AppImage manually
        run: |
          set -euo pipefail

          echo "ðŸ”¨ Building AppImage..."

          BINARY_PATH="src-tauri/target/release/proton-drive"
          APPDIR="AppDir"

          if [ ! -f "$BINARY_PATH" ]; then
            echo "âŒ Binary not found at $BINARY_PATH"
            exit 1
          fi

          # Create AppDir structure
          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/share/applications"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/scalable/apps"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/128x128/apps"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/32x32/apps"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"

          cp "$BINARY_PATH" "$APPDIR/usr/bin/proton-drive"
          chmod +x "$APPDIR/usr/bin/proton-drive"

          cat > "$APPDIR/usr/share/applications/com.proton.drive.desktop" << 'EOF'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Proton Drive
          Comment=Secure cloud storage
          Exec=proton-drive %U
          Icon=com.proton.drive
          Categories=Utility;Network;FileTransfer;
          Keywords=proton;drive;cloud;storage;sync;
          Terminal=false
          StartupWMClass=proton-drive
          StartupNotify=true
          EOF

          cp src-tauri/icons/proton-drive.svg "$APPDIR/usr/share/icons/hicolor/scalable/apps/com.proton.drive.svg"
          cp src-tauri/icons/128x128.png "$APPDIR/usr/share/icons/hicolor/128x128/apps/com.proton.drive.png"
          cp src-tauri/icons/32x32.png "$APPDIR/usr/share/icons/hicolor/32x32/apps/com.proton.drive.png"
          cp src-tauri/icons/128x128@2x.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/com.proton.drive.png"

          cp "$APPDIR/usr/share/applications/com.proton.drive.desktop" "$APPDIR/com.proton.drive.desktop"
          cp src-tauri/icons/proton-drive.svg "$APPDIR/com.proton.drive.svg"
          ln -sf usr/share/icons/hicolor/128x128/apps/com.proton.drive.png "$APPDIR/.DirIcon"

          cat > "$APPDIR/AppRun" << 'APPRUN_EOF'
          #!/bin/bash
          export WEBKIT_DISABLE_DMABUF_RENDERER=1
          export WEBKIT_DISABLE_COMPOSITING_MODE=1

          HERE="$(dirname "$(readlink -f "${0}")")"
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"

          exec "${HERE}/usr/bin/proton-drive" "$@"
          APPRUN_EOF
          chmod +x "$APPDIR/AppRun"

          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool
          ./appimagetool --appimage-extract

          ARCH=x86_64 ./squashfs-root/AppRun "$APPDIR" "proton-drive_${VERSION}_amd64.AppImage"

          mkdir -p src-tauri/target/release/bundle/appimage
          mv "proton-drive_${VERSION}_amd64.AppImage" src-tauri/target/release/bundle/appimage/

          rm -rf "$APPDIR" appimagetool squashfs-root

          echo "âœ… AppImage created successfully"
          ls -lh src-tauri/target/release/bundle/appimage/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: error
          retention-days: 30
