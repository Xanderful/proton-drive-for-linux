name: Build Flatpak
on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-flatpak:
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Free disk space
        run: |
          echo "ğŸ§¹ Freeing disk space aggressively..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/share/swift /usr/local/share/powershell /usr/local/share/chromium
          sudo rm -rf /opt/hostedtoolcache/go /opt/hostedtoolcache/node /opt/hostedtoolcache/Python
          sudo docker image prune --all --force || true
          sudo apt-get clean || true
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync version from package.json
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Building version: $VERSION"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "0,/^version = \"[^\"]*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf \
            flatpak \
            flatpak-builder \
            python3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Clone and patch WebClients
        run: |
          set -euo pipefail

          echo "ğŸ“¥ Cloning WebClients..."
          rm -rf WebClients .git/modules/WebClients 2>/dev/null || true
          git clean -fdx WebClients 2>/dev/null || true
          git clone --depth=1 --single-branch --branch main \
            https://github.com/ProtonMail/WebClients.git WebClients

          echo "ğŸ”§ Patching dependencies and configuring Yarn..."
          python3 scripts/fix_deps.py
          # Create empty yarn.lock to mark WebClients as separate project (prevents workspace detection issues)
          : > WebClients/yarn.lock

      - name: Build WebClients (Proton Drive)
        run: |
          set -euo pipefail
          mv ./package.json ./package.json.bak 2>/dev/null || true
          mv ./yarn.lock ./yarn.lock.bak 2>/dev/null || true
          cd WebClients
          echo "ğŸ“¦ Installing WebClients dependencies..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 900000
          cd ..
          mv ./package.json.bak ./package.json 2>/dev/null || true
          mv ./yarn.lock.bak ./yarn.lock 2>/dev/null || true
          echo "ğŸ“¦ Creating stubs for private packages..."
          python3 scripts/create_stubs.py
          cd WebClients
          echo "ğŸ”¨ Building Proton Drive web app..."
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build:web

          echo "ğŸ”¨ Building Account app for SSO..."
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-account build:web || echo "Account build failed"

          echo "ğŸ”¨ Building Verify app for captcha..."
          node .yarn/releases/yarn-4.12.0.cjs workspace proton-verify build:web || echo "Verify build optional"

          echo "ğŸ“¦ Copying account app to drive dist..."
          if [ -d "applications/account/dist" ]; then
            cp -r applications/account/dist applications/drive/dist/account
            echo "ğŸ”§ Fixing account app paths for nested deployment..."
            find applications/drive/dist/account -name "*.html" -exec sed -i \
              -e 's|<base href="/">|<base href="/account/">|g' \
              -e 's|href="/assets/|href="/account/assets/|g' \
              -e 's|src="/assets/|src="/account/assets/|g' \
              -e 's|content="/assets/|content="/account/assets/|g' {} \;
            # Fix asset paths in JavaScript files (runtime chunks reference other chunks)
            find applications/drive/dist/account -name "*.js" -exec sed -i \
              -e 's|"assets/static/|"/account/assets/static/|g' \
              -e 's|"/assets/static/|"/account/assets/static/|g' {} \;
            echo "âœ… Account app copied and paths fixed"
          fi

          echo "ğŸ“¦ Copying verify app to drive dist..."
          if [ -d "applications/verify/dist" ]; then
            cp -r applications/verify/dist applications/drive/dist/verify
            echo "ğŸ”§ Fixing verify app paths for nested deployment..."
            find applications/drive/dist/verify -name "*.html" -exec sed -i \
              -e 's|<base href="/">|<base href="/verify/">|g' \
              -e 's|href="/assets/|href="/verify/assets/|g' \
              -e 's|src="/assets/|src="/verify/assets/|g' \
              -e 's|content="/assets/|content="/verify/assets/|g' {} \;
            # Fix asset paths in JavaScript files
            find applications/drive/dist/verify -name "*.js" -exec sed -i \
              -e 's|"assets/static/|"/verify/assets/static/|g' \
              -e 's|"/assets/static/|"/verify/assets/static/|g' {} \;
            echo "âœ… Verify app copied and paths fixed"
          fi

          if [ ! -d "applications/drive/dist" ]; then
            echo "âŒ Build failed - no output directory"
            exit 1
          fi
          echo "âœ… WebClients build complete"
          ls -la applications/drive/dist/
          cd ..

      - name: Verify asset paths (prevent white screen)
        run: |
          DIST_PATH="WebClients/applications/drive/dist"

          # CRITICAL: Verify account app paths are correctly prefixed
          if [ -f "$DIST_PATH/account/index.html" ]; then
            echo "ğŸ” Verifying account app asset paths..."
            if grep -q 'src="/assets/' "$DIST_PATH/account/index.html"; then
              echo "âŒ CRITICAL: Account app has unfixed asset paths!"
              echo "   This will cause white screen in packaged apps!"
              exit 1
            fi
            if ! grep -q '<base href="/account/">' "$DIST_PATH/account/index.html"; then
              echo "âŒ CRITICAL: Account app missing correct base href!"
              exit 1
            fi
            echo "âœ… Account app paths verified"
          fi

          if [ -f "$DIST_PATH/verify/index.html" ]; then
            if grep -q 'src="/assets/' "$DIST_PATH/verify/index.html"; then
              echo "âŒ CRITICAL: Verify app has unfixed asset paths!"
              exit 1
            fi
            echo "âœ… Verify app paths verified"
          fi

      - name: Install Tauri dependencies
        run: npm install

      - name: Build Tauri binary only (no bundling)
        run: |
          echo "ğŸ”¨ Building Tauri binary..."
          cd src-tauri
          cargo build --release
          cd ..
          echo "âœ… Tauri build complete"
          echo "Built binaries:"
          ls -la src-tauri/target/release/ | grep -E '^-.*x'
          # Verify the binary exists
          if [ ! -f src-tauri/target/release/proton-drive ]; then
            echo "âŒ Expected binary 'proton-drive' not found"
            echo "Available files:"
            ls -la src-tauri/target/release/
            exit 1
          fi

      - name: Free disk space before Flatpak
        run: |
          echo "ğŸ§¹ Cleaning up to make room for Flatpak SDK..."
          rm -rf WebClients/node_modules WebClients/.yarn/cache
          rm -rf src-tauri/target/release/deps src-tauri/target/release/build
          rm -rf src-tauri/target/release/.fingerprint src-tauri/target/release/incremental
          sudo apt-get clean
          df -h

      - name: Setup Flatpak
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.gnome.Platform//47 org.gnome.Sdk//47

      - name: Create wrapper script for WebKitGTK compatibility
        run: |
          cat > proton-drive-wrapper.sh << 'EOF'
          #!/bin/bash
          # Fix WebKitGTK EGL/GPU issues on various Linux configurations
          export WEBKIT_DISABLE_DMABUF_RENDERER=1
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          exec /app/bin/proton-drive-bin "$@"
          EOF
          chmod +x proton-drive-wrapper.sh

      - name: Create desktop file
        run: |
          cat > com.proton.drive.desktop << 'EOF'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Proton Drive
          Comment=Secure cloud storage
          Exec=proton-drive
          Icon=com.proton.drive
          Categories=Network;FileTransfer;
          Keywords=proton;drive;cloud;storage;sync;
          EOF

      - name: Prepare Flatpak staging directory
        run: |
          echo "ğŸ“¦ Creating staging directory with only required files..."
          mkdir -p flatpak-staging/icons
          cp src-tauri/target/release/proton-drive flatpak-staging/proton-drive-bin
          cp proton-drive-wrapper.sh flatpak-staging/proton-drive
          cp src-tauri/icons/32x32.png flatpak-staging/icons/
          cp src-tauri/icons/128x128.png flatpak-staging/icons/
          cp src-tauri/icons/128x128@2x.png flatpak-staging/icons/
          cp src-tauri/icons/proton-drive.svg flatpak-staging/icons/
          cp com.proton.drive.desktop flatpak-staging/
          echo "âœ… Staging directory ready:"
          ls -la flatpak-staging/

      - name: Create Flatpak manifest
        run: |
          cat > com.proton.drive.yml << 'EOF'
          app-id: com.proton.drive
          runtime: org.gnome.Platform
          runtime-version: '47'
          sdk: org.gnome.Sdk
          command: proton-drive
          finish-args:
            - --share=network
            - --share=ipc
            - --socket=x11
            - --socket=wayland
            - --socket=pulseaudio
            - --device=dri
            - --filesystem=home
            - --filesystem=xdg-download
            - --talk-name=org.freedesktop.secrets
            - --talk-name=org.freedesktop.Notifications
            - --system-talk-name=org.freedesktop.NetworkManager
          modules:
            - name: proton-drive
              buildsystem: simple
              sources:
                - type: dir
                  path: flatpak-staging
              build-commands:
                - install -Dm755 proton-drive-bin /app/bin/proton-drive-bin
                - install -Dm755 proton-drive /app/bin/proton-drive
                - install -Dm644 icons/32x32.png /app/share/icons/hicolor/32x32/apps/com.proton.drive.png
                - install -Dm644 icons/128x128.png /app/share/icons/hicolor/128x128/apps/com.proton.drive.png
                - install -Dm644 icons/128x128@2x.png /app/share/icons/hicolor/256x256/apps/com.proton.drive.png
                - install -Dm644 icons/proton-drive.svg /app/share/icons/hicolor/scalable/apps/com.proton.drive.svg
                - install -Dm644 com.proton.drive.desktop /app/share/applications/com.proton.drive.desktop
          EOF
          # Remove leading indentation from the generated file
          sed -i 's/^          //' com.proton.drive.yml

      - name: Build Flatpak
        run: |
          flatpak-builder --user --force-clean --repo=repo build-dir com.proton.drive.yml

      - name: Create Flatpak bundle
        run: |
          flatpak build-bundle repo proton-drive.flatpak com.proton.drive

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: proton-drive.flatpak
          if-no-files-found: error
          retention-days: 30

      - name: Upload Flatpak manifest
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-manifest
          path: |
            com.proton.drive.yml
            com.proton.drive.desktop
          if-no-files-found: error
          retention-days: 30