name: Build Snap

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-snap:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf \
            python3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create snapcraft.yaml
        run: |
          mkdir -p snap
          # We use a literal heredoc 'EOF' to prevent shell expansion of $ variables
          cat > snap/snapcraft.yaml << 'EOF'
name: proton-drive
version: '1.1.0'
summary: Proton Drive Linux Desktop Client
description: |
  Fast, lightweight, and unofficial desktop GUI client for Proton Drive on Linux.
  Built with Tauri and Rust for a native-performance experience.

grade: stable
confinement: strict
base: core24
platforms:
  amd64:
  arm64:

title: Proton Drive Linux Desktop Client
contact: https://github.com/DonnieDice/protondrive-linux/issues
license: AGPL-3.0

apps:
  proton-drive:
    command: usr/bin/proton-drive-wrapper
    environment:
      WEBKIT_DISABLE_DMABUF_RENDERER: "1"
      WEBKIT_DISABLE_COMPOSITING_MODE: "1"
    desktop: usr/share/applications/com.proton.drive.desktop
    plugs:
      - home
      - network
      - network-bind
      - network-status
      - desktop
      - desktop-legacy
      - x11
      - wayland
      - opengl
      - audio-playback
      - browser-support
      - password-manager-service
      - dbus

plugs:
  dbus:
    interface: dbus
    bus: session
    name: com.proton.drive

parts:
  proton-drive:
    plugin: nil
    source: .
    override-build: |
      set -euo pipefail
      
      # Install Rust
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      export PATH="$HOME/.cargo/bin:$PATH"
      
      # Install Node.js 22
      curl -fsSL https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-x64.tar.xz -o /tmp/node.tar.xz
      tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1
      
      # Build Logic
      git clone --depth=1 --single-branch --branch main https://github.com/ProtonMail/WebClients.git WebClients
      python3 scripts/fix_deps.py
      
      mv ./package.json ./package.json.bak 2>/dev/null || true
      cd WebClients
      export NODE_OPTIONS="--max-old-space-size=8192"
      node .yarn/releases/yarn-4.12.0.cjs install
      node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build:web
      cd ..
      mv ./package.json.bak ./package.json 2>/dev/null || true
      
      python3 scripts/create_stubs.py
      npm install
      cd src-tauri && cargo build --release --features protocol-asset && cd ..
      
      # Install to Snap
      install -Dm755 src-tauri/target/release/proton-drive "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive"
      
      cat > "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive-wrapper" << 'WRAPPER'
      #!/bin/bash
      export WEBKIT_DISABLE_DMABUF_RENDERER=1
      export WEBKIT_DISABLE_COMPOSITING_MODE=1
      exec "$SNAP/usr/bin/proton-drive" "$@"
      WRAPPER
      chmod +x "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive-wrapper"
      
      mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/applications"
      cat > "$SNAPCRAFT_PART_INSTALL/usr/share/applications/com.proton.drive.desktop" << 'DESKTOP'
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Proton Drive
      Comment=Secure cloud storage
      Exec=proton-drive-wrapper
      Icon=com.proton.drive
      Categories=Utility;
      DESKTOP

      mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps"
      cp src-tauri/icons/128x128.png "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps/com.proton.drive.png"

    build-packages:
      - curl
      - git
      - build-essential
      - libssl-dev
      - libwebkit2gtk-4.1-dev
      - libgtk-3-dev
      - libayatana-appindicator3-dev
      - librsvg2-dev
      - libsoup-3.0-dev
      - patchelf
    stage-packages:
      - libssl3
      - libwebkit2gtk-4.1-0
      - libgtk-3-0
      - libayatana-appindicator3-1
      - libsoup-3.0-0
EOF

      - name: Build Snap package
        uses: snapcore/action-build@v1
        with:
          snapcraft-channel: latest/edge

      - name: Upload Snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: snap-package
          path: '*.snap'
          if-no-files-found: error