name: Build Snap
on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  RUST_VERSION: "stable"

jobs:
  build-snap:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "0,/^version = \"[^\"]*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

      - name: Create snapcraft.yaml
        env:
          SNAP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p snap
          cat > snap/snapcraft.yaml << EOF
          name: proton-drive
          version: "${SNAP_VERSION}"
          summary: Proton Drive Linux Desktop Client
          description: |
            Fast, lightweight, and unofficial desktop GUI client for Proton Drive on Linux.
            Built with Tauri and Rust for a native-performance experience.
          grade: stable
          confinement: strict
          base: core24
          platforms:
            amd64:
          title: Proton Drive Linux Desktop Client
          contact: https://github.com/DonnieDice/protondrive-linux/issues
          license: AGPL-3.0

          apps:
            proton-drive:
              command: usr/bin/proton-drive-wrapper
              environment:
                WEBKIT_DISABLE_DMABUF_RENDERER: "1"
                WEBKIT_DISABLE_COMPOSITING_MODE: "1"
              desktop: usr/share/applications/com.proton.drive.desktop
              plugs:
                - home
                - network
                - network-bind
                - network-status
                - desktop
                - desktop-legacy
                - x11
                - wayland
                - opengl
                - audio-playback
                - browser-support
                - password-manager-service

          parts:
            proton-drive:
              plugin: nil
              source: .
              override-build: |
                set -euo pipefail
                # Install Rust
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
                export PATH="\$HOME/.cargo/bin:\$PATH"
                rustc --version
                # Install Node.js
                curl -fsSL https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-x64.tar.xz -o /tmp/node.tar.xz
                tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1
                rm /tmp/node.tar.xz
                # Install Tauri deps and build
                npm install
                cd src-tauri && cargo build --release && cd ..
                if [ ! -f "src-tauri/target/release/proton-drive" ]; then
                  echo "Binary not found!"
                  exit 1
                fi
                # Install binary
                install -Dm755 src-tauri/target/release/proton-drive "\$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive"
                # Wrapper script
                mkdir -p "\$SNAPCRAFT_PART_INSTALL/usr/bin"
                cat > "\$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive-wrapper" << 'WRAPPER'
          #!/bin/bash
          export WEBKIT_DISABLE_DMABUF_RENDERER=1
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          exec "\$SNAP/usr/bin/proton-drive" "\$@"
          WRAPPER
                chmod +x "\$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive-wrapper"
                # Desktop file
                mkdir -p "\$SNAPCRAFT_PART_INSTALL/usr/share/applications"
                cat > "\$SNAPCRAFT_PART_INSTALL/usr/share/applications/com.proton.drive.desktop" << 'DESKTOP'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Proton Drive
          Comment=Secure cloud storage
          Exec=proton-drive-wrapper
          Icon=com.proton.drive
          Categories=Utility;Network;
          DESKTOP
                # Icons
                mkdir -p "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/32x32/apps"
                mkdir -p "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps"
                mkdir -p "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/256x256/apps"
                mkdir -p "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/scalable/apps"
                cp src-tauri/icons/32x32.png "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/32x32/apps/com.proton.drive.png"
                cp src-tauri/icons/128x128.png "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps/com.proton.drive.png"
                cp src-tauri/icons/128x128@2x.png "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/256x256/apps/com.proton.drive.png"
                cp src-tauri/icons/proton-drive.svg "\$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/scalable/apps/com.proton.drive.svg"
              build-packages:
                - curl
                - wget
                - file
                - git
                - build-essential
                - libssl-dev
                - libwebkit2gtk-4.1-dev
                - libgtk-3-dev
                - libayatana-appindicator3-dev
                - librsvg2-dev
                - libsoup-3.0-dev
                - patchelf
              stage-packages:
                - libssl3
                - libwebkit2gtk-4.1-0
                - libgtk-3-0
                - libayatana-appindicator3-1
                - librsvg2-2
                - libsoup-3.0-0
          EOF

      - name: Build Snap package
        uses: snapcore/action-build@v1
        with:
          snapcraft-channel: latest/edge

      - name: Upload Snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: snap-package
          path: '*.snap'
          if-no-files-found: error
          retention-days: 30
