name: Build Snap
on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-snap:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf \
            python3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "0,/^version = \"[^\"]*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

      - name: Create snapcraft.yaml
        env:
          SNAP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p snap
          cat > snap/snapcraft.yaml << 'SNAPEOF'
          name: proton-drive
          summary: Proton Drive Linux Desktop Client
          description: |
            Fast, lightweight, and unofficial desktop GUI client for Proton Drive on Linux.
            Built with Tauri and Rust for a native-performance experience.
          grade: stable
          confinement: strict
          base: core24
          platforms:
            amd64:
            arm64:
          title: Proton Drive Linux Desktop Client
          contact: https://github.com/DonnieDice/protondrive-linux/issues
          license: AGPL-3.0

          apps:
            proton-drive:
              command: usr/bin/proton-drive-wrapper
              environment:
                WEBKIT_DISABLE_DMABUF_RENDERER: "1"
                WEBKIT_DISABLE_COMPOSITING_MODE: "1"
              desktop: usr/share/applications/com.proton.drive.desktop
              plugs:
                - home
                - network
                - network-bind
                - network-status
                - desktop
                - desktop-legacy
                - x11
                - wayland
                - opengl
                - audio-playback
                - browser-support
                - password-manager-service
                - dbus

          plugs:
            dbus:
              interface: dbus
              bus: session
              name: com.proton.drive

          parts:
            proton-drive:
              plugin: nil
              source: .
              override-build: |
                set -euo pipefail
                # Install Rust
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
                export PATH="$HOME/.cargo/bin:$PATH"
                rustc --version
                # Install Node.js 22
                curl -fsSL https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-x64.tar.xz -o /tmp/node.tar.xz
                tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1
                rm /tmp/node.tar.xz
                node --version
                npm --version
                # Clone WebClients
                echo "Cloning WebClients..."
                rm -rf WebClients 2>/dev/null || true
                git clone --depth=1 --single-branch --branch main https://github.com/ProtonMail/WebClients.git WebClients
                # Patch dependencies
                echo "Patching dependencies..."
                python3 scripts/fix_deps.py
                : > WebClients/yarn.lock
                # Build WebClients
                mv ./package.json ./package.json.bak 2>/dev/null || true
                mv ./yarn.lock ./yarn.lock.bak 2>/dev/null || true
                cd WebClients
                export NODE_OPTIONS="--max-old-space-size=8192"
                node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 900000
                cd ..
                mv ./package.json.bak ./package.json 2>/dev/null || true
                mv ./yarn.lock.bak ./yarn.lock 2>/dev/null || true
                python3 scripts/create_stubs.py
                cd WebClients
                node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build:web
                node .yarn/releases/yarn-4.12.0.cjs workspace proton-account build:web || echo "Account build failed"
                node .yarn/releases/yarn-4.12.0.cjs workspace proton-verify build:web || echo "Verify build optional"
                # Copy and fix account app
                if [ -d "applications/account/dist" ]; then
                  cp -r applications/account/dist applications/drive/dist/account
                  find applications/drive/dist/account -name "*.html" -exec sed -i \
                    -e 's|<base href="/">|<base href="/account/">|g' \
                    -e 's|href="/assets/|href="/account/assets/|g' \
                    -e 's|src="/assets/|src="/account/assets/|g' \
                    -e 's|content="/assets/|content="/account/assets/|g' {} \;
                  find applications/drive/dist/account -name "*.js" -exec sed -i \
                    -e 's|"assets/static/|"/account/assets/static/|g' \
                    -e 's|"/assets/static/|"/account/assets/static/|g' {} \;
                fi
                # Copy and fix verify app
                if [ -d "applications/verify/dist" ]; then
                  cp -r applications/verify/dist applications/drive/dist/verify
                  find applications/drive/dist/verify -name "*.html" -exec sed -i \
                    -e 's|<base href="/">|<base href="/verify/">|g' \
                    -e 's|href="/assets/|href="/verify/assets/|g' \
                    -e 's|src="/assets/|src="/verify/assets/|g' \
                    -e 's|content="/assets/|content="/verify/assets/|g' {} \;
                  find applications/drive/dist/verify -name "*.js" -exec sed -i \
                    -e 's|"assets/static/|"/verify/assets/static/|g' \
                    -e 's|"/assets/static/|"/verify/assets/static/|g' {} \;
                fi
                # Verify build
                if [ ! -d "applications/drive/dist" ]; then
                  echo "Build failed - no output directory"
                  exit 1
                fi
                # Verify account paths
                if [ -f "applications/drive/dist/account/index.html" ]; then
                  if grep -q 'src="/assets/' "applications/drive/dist/account/index.html"; then
                    echo "CRITICAL: Account app has unfixed asset paths!"
                    exit 1
                  fi
                fi
                cd ..
                # Build Tauri
                npm install
                cd src-tauri && cargo build --release && cd ..
                if [ ! -f "src-tauri/target/release/proton-drive" ]; then
                  echo "Binary not found!"
                  exit 1
                fi
                # Install files
                install -Dm755 src-tauri/target/release/proton-drive "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive"
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/bin"
                cat > "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive-wrapper" << 'WRAPPEREOF'
                #!/bin/bash
                export WEBKIT_DISABLE_DMABUF_RENDERER=1
                export WEBKIT_DISABLE_COMPOSITING_MODE=1
                exec "$SNAP/usr/bin/proton-drive" "$@"
                WRAPPEREOF
                chmod +x "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive-wrapper"
                # Desktop file
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/applications"
                cat > "$SNAPCRAFT_PART_INSTALL/usr/share/applications/com.proton.drive.desktop" << 'DESKTOPEOF'
                [Desktop Entry]
                Version=1.0
                Type=Application
                Name=Proton Drive
                Comment=Secure cloud storage
                Exec=proton-drive-wrapper
                Icon=com.proton.drive
                Categories=Utility;
                DESKTOPEOF
                # Icons
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/32x32/apps"
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps"
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/scalable/apps"
                cp src-tauri/icons/32x32.png "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/32x32/apps/com.proton.drive.png"
                cp src-tauri/icons/128x128.png "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps/com.proton.drive.png"
                cp src-tauri/icons/proton-drive.svg "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/scalable/apps/com.proton.drive.svg"
              build-packages:
                - curl
                - wget
                - file
                - git
                - build-essential
                - libssl-dev
                - libwebkit2gtk-4.1-dev
                - libgtk-3-dev
                - libayatana-appindicator3-dev
                - librsvg2-dev
                - libsoup-3.0-dev
                - patchelf
              stage-packages:
                - libssl3
                - libwebkit2gtk-4.1-0
                - libgtk-3-0
                - libayatana-appindicator3-1
                - librsvg2-2
                - libsoup-3.0-0
          SNAPEOF
          # Fix indentation - remove leading spaces from heredoc
          sed -i 's/^          //' snap/snapcraft.yaml
          # Add version
          sed -i "2i version: \"${SNAP_VERSION}\"" snap/snapcraft.yaml

      - name: Build Snap package
        uses: snapcore/action-build@v1
        with:
          snapcraft-channel: latest/edge

      - name: Upload Snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: snap-package
          path: '*.snap'
          if-no-files-found: error
          retention-days: 30
