name: Build Snap

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"
  RUST_VERSION: "stable"

jobs:
  build-snap:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup2.4-dev \
            patchelf \
            python3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create snapcraft.yaml
        run: |
          mkdir -p snap
          cat > snap/snapcraft.yaml << 'EOF'
          name: proton-drive
          version: '1.0.0'
          summary: Proton Drive Linux Desktop Client
          description: |
            Fast, lightweight, and unofficial desktop GUI client for Proton Drive on Linux.
            Built with Tauri and Rust for a native-performance experience.

            Features:
            - Secure Proton Drive Integration
            - Native Desktop Experience
            - Privacy-Focused
            - Cross-platform Support

          grade: stable
          confinement: strict
          base: core24
          platforms:
            amd64:
            arm64:

          apps:
            proton-drive:
              command: proton-drive
              desktop: usr/share/applications/com.proton.drive.desktop
              plugs:
                - home
                - network
                - network-bind
                - desktop
                - desktop-legacy
                - x11
                - wayland
                - dbus

          plugs:
            dbus:
              interface: dbus
              bus: session
              name: com.proton.drive

          parts:
            proton-drive:
              plugin: nil
              source: .
              override-build: |
                set -euo pipefail

                # Install Node.js 22
                curl -fsSL https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-x64.tar.xz -o /tmp/node.tar.xz
                tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1
                rm /tmp/node.tar.xz
                node --version
                npm --version
                npm install -g yarn

                # Install Node.js dependencies
                npm install

                # Clone and build WebClients
                rm -rf WebClients .git/modules/WebClients 2>/dev/null || true
                git clone --depth=1 --single-branch --branch main \
                  https://github.com/ProtonMail/WebClients.git WebClients

                python3 scripts/fix_deps.py

                # Delete lockfile to force regeneration after patching
                rm -f WebClients/yarn.lock

                # Temporarily move root package.json and yarn.lock to avoid workspace conflicts
                # Yarn detects workspaces if both package.json and yarn.lock exist in parent dir
                mv package.json package.json.bak 2>/dev/null || true
                mv yarn.lock yarn.lock.bak 2>/dev/null || true

                cd WebClients

                export NODE_OPTIONS="--max-old-space-size=8192"
                node .yarn/releases/yarn-4.12.0.cjs install --network-timeout 900000

                # Restore root package.json and yarn.lock
                cd ..
                mv package.json.bak package.json 2>/dev/null || true
                mv yarn.lock.bak yarn.lock 2>/dev/null || true

                python3 scripts/create_stubs.py

                cd WebClients
                node .yarn/releases/yarn-4.12.0.cjs workspace proton-drive build:web
                cd ..

                # Verify build
                if [ ! -d "WebClients/applications/drive/dist" ]; then
                  echo "âŒ WebClients build failed"
                  exit 1
                fi

                # Build with Tauri
                yarn install
                yarn tauri build -- --bundles appimage

                # Install the binary
                install -Dm755 src-tauri/target/release/proton-drive \
                  "$SNAPCRAFT_PART_INSTALL/usr/bin/proton-drive"

                # Install desktop file
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/applications"
                cat > "$SNAPCRAFT_PART_INSTALL/usr/share/applications/com.proton.drive.desktop" << 'DESKTOP'
                [Desktop Entry]
                Version=1.0
                Type=Application
                Name=Proton Drive
                Comment=Secure cloud storage
                Exec=proton-drive
                Icon=com.proton.drive
                Categories=Utility;
                DESKTOP

                # Install icon
                mkdir -p "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps"
                cp src-tauri/icons/128x128.png \
                  "$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps/com.proton.drive.png"

              build-packages:
                - curl
                - wget
                - file
                - git
                - python3
                - python3-pip
                - rustc
                - cargo
                - build-essential
                - libssl-dev
                - libwebkit2gtk-4.1-dev
                - libgtk-3-dev
                - libayatana-appindicator3-dev
                - librsvg2-dev
                - libsoup2.4-dev
                - patchelf

              stage-packages:
                - libssl3
                - libwebkit2gtk-4.1-0
                - libgtk-3-0
                - libayatana-appindicator3-1
                - librsvg2-2
          EOF

      - name: Build Snap package
        uses: snapcore/action-build@v1
        with:
          snapcraft-channel: latest/edge

      - name: Upload Snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: snap-package
          path: '*.snap'
          if-no-files-found: error
          retention-days: 30

      - name: Upload snapcraft.yaml
        uses: actions/upload-artifact@v4
        with:
          name: snap-config
          path: snap/snapcraft.yaml
          retention-days: 30